{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/mohamed/abcher/app/dashboard/attendance/page.tsx"],"sourcesContent":["\"use client\";\n\nimport Link from \"next/link\";\nimport { useCallback, useEffect, useMemo, useState } from \"react\";\nimport toast from \"react-hot-toast\";\n\nimport { createClient } from \"@/lib/supabase/client\";\nimport type { Student, UserRole } from \"@/lib/types\";\n\ninterface ProfileContext {\n  school_id: string | null;\n  role: UserRole | null;\n}\n\ntype AttendanceStatus = \"present\" | \"absent\" | \"late\" | \"excused\";\n\ninterface AttendanceRecord {\n  student_id: string;\n  status: AttendanceStatus;\n}\n\nconst statusLabels: Record<AttendanceStatus, string> = {\n  present: \"حاضر\",\n  absent: \"غائب\",\n  late: \"متأخر\",\n  excused: \"بعذر\",\n};\n\nconst supabase = createClient();\n\nexport default function AttendancePage() {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [schoolId, setSchoolId] = useState<string | null>(null);\n  const [role, setRole] = useState<UserRole | null>(null);\n  const [students, setStudents] = useState<Student[]>([]);\n  const [selectedDate, setSelectedDate] = useState<string>(() => new Date().toISOString().slice(0, 10));\n  const [statusMap, setStatusMap] = useState<Record<string, AttendanceStatus>>({});\n\n  const canSave = role === \"school_admin\" || role === \"teacher\";\n\n  const loadAttendance = useCallback(async () => {\n    setLoading(true);\n\n    try {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n\n      if (!user) {\n        throw new Error(\"يرجى تسجيل الدخول أولًا.\");\n      }\n\n      const { data: profile, error: profileError } = await supabase\n        .from(\"profiles\")\n        .select(\"school_id, role\")\n        .eq(\"id\", user.id)\n        .single<ProfileContext>();\n\n      if (profileError) {\n        throw profileError;\n      }\n\n      setRole(profile?.role ?? null);\n\n      if (!profile?.school_id) {\n        setSchoolId(null);\n        setStudents([]);\n        setStatusMap({});\n        return;\n      }\n\n      setSchoolId(profile.school_id);\n\n      const [studentsRes, attendanceRes] = await Promise.all([\n        supabase\n          .from(\"students\")\n          .select(\"id,school_id,full_name,level,parent_phone,created_at\")\n          .eq(\"school_id\", profile.school_id)\n          .order(\"full_name\", { ascending: true }),\n        supabase\n          .from(\"attendance\")\n          .select(\"student_id,status\")\n          .eq(\"school_id\", profile.school_id)\n          .eq(\"date\", selectedDate),\n      ]);\n\n      if (studentsRes.error || attendanceRes.error) {\n        throw studentsRes.error || attendanceRes.error;\n      }\n\n      const loadedStudents = (studentsRes.data as Student[]) ?? [];\n      setStudents(loadedStudents);\n\n      const map: Record<string, AttendanceStatus> = {};\n      ((attendanceRes.data as AttendanceRecord[]) ?? []).forEach((record) => {\n        map[record.student_id] = record.status;\n      });\n\n      loadedStudents.forEach((student) => {\n        if (!map[student.id]) {\n          map[student.id] = \"present\";\n        }\n      });\n\n      setStatusMap(map);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"تعذر تحميل بيانات الحضور.\";\n      toast.error(message);\n    } finally {\n      setLoading(false);\n    }\n  }, [selectedDate]);\n\n  useEffect(() => {\n    void loadAttendance();\n  }, [loadAttendance]);\n\n  const summary = useMemo(() => {\n    const counts = { present: 0, absent: 0, late: 0, excused: 0 };\n\n    Object.values(statusMap).forEach((status) => {\n      counts[status] += 1;\n    });\n\n    return counts;\n  }, [statusMap]);\n\n  const setStatus = (studentId: string, status: AttendanceStatus) => {\n    setStatusMap((previous) => ({ ...previous, [studentId]: status }));\n  };\n\n  const saveAttendance = async () => {\n    if (!schoolId) {\n      toast.error(\"تعذر معرفة المدرسة الحالية.\");\n      return;\n    }\n\n    if (!canSave) {\n      toast.error(\"ليس لديك صلاحية حفظ الحضور.\");\n      return;\n    }\n\n    setSaving(true);\n\n    try {\n      const payload = students.map((student) => ({\n        school_id: schoolId,\n        student_id: student.id,\n        date: selectedDate,\n        status: statusMap[student.id] ?? \"present\",\n      }));\n\n      const { error } = await supabase.from(\"attendance\").upsert(payload, {\n        onConflict: \"student_id,date\",\n      });\n\n      if (error) {\n        throw error;\n      }\n\n      toast.success(\"تم حفظ الحضور بنجاح.\");\n      await loadAttendance();\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"تعذر حفظ الحضور.\";\n      toast.error(message);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <section dir=\"rtl\" className=\"flex min-h-[65vh] items-center justify-center\">\n        <div className=\"h-11 w-11 animate-spin rounded-full border-4 border-primary-100 border-t-primary-600\" />\n      </section>\n    );\n  }\n\n  if (!schoolId) {\n    return (\n      <section dir=\"rtl\" className=\"rounded-xl bg-white p-6 text-center shadow-md\">\n        <h1 className=\"mb-3 text-2xl font-bold text-primary-700\">لا توجد مدرسة مرتبطة</h1>\n        <p className=\"mb-6 text-gray-600\">أكمل الإعداد حتى تتمكن من تسجيل الحضور.</p>\n        <Link\n          href=\"/onboarding\"\n          className=\"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700\"\n        >\n          إكمال الإعداد\n        </Link>\n      </section>\n    );\n  }\n\n  if (students.length === 0) {\n    return (\n      <section dir=\"rtl\" className=\"rounded-xl bg-white p-6 text-center shadow-md\">\n        <h1 className=\"mb-3 text-2xl font-bold text-primary-700\">لا توجد قائمة طلبة</h1>\n        <p className=\"mb-6 text-gray-600\">أضف طلبة أولًا لتفعيل سجل الحضور.</p>\n        <Link\n          href=\"/dashboard/students\"\n          className=\"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700\"\n        >\n          إضافة طلبة\n        </Link>\n      </section>\n    );\n  }\n\n  return (\n    <section dir=\"rtl\" className=\"space-y-5\">\n      <header className=\"rounded-xl bg-white p-6 shadow-md\">\n        <h1 className=\"text-2xl font-bold text-primary-700\">سجل الحضور اليومي</h1>\n        <p className=\"mt-2 text-gray-600\">حدد تاريخًا ثم اختر حالة كل طالب.</p>\n      </header>\n\n      <section className=\"rounded-xl bg-white p-6 shadow-md\">\n        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-4\">\n          <div>\n            <label htmlFor=\"attendance-date\" className=\"mb-2 block text-sm font-semibold text-gray-700\">\n              التاريخ\n            </label>\n            <input\n              id=\"attendance-date\"\n              type=\"date\"\n              value={selectedDate}\n              onChange={(event) => setSelectedDate(event.target.value)}\n              className=\"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring\"\n            />\n          </div>\n          <div className=\"rounded-lg bg-primary-50 p-4 text-center\">\n            <p className=\"text-sm text-gray-600\">حاضر</p>\n            <p className=\"text-2xl font-bold text-primary-700\">{summary.present}</p>\n          </div>\n          <div className=\"rounded-lg bg-red-50 p-4 text-center\">\n            <p className=\"text-sm text-gray-600\">غائب</p>\n            <p className=\"text-2xl font-bold text-red-600\">{summary.absent}</p>\n          </div>\n          <div className=\"rounded-lg bg-amber-50 p-4 text-center\">\n            <p className=\"text-sm text-gray-600\">متأخر/بعذر</p>\n            <p className=\"text-2xl font-bold text-amber-600\">{summary.late + summary.excused}</p>\n          </div>\n        </div>\n      </section>\n\n      <section className=\"overflow-hidden rounded-xl bg-white shadow-md\">\n        <div className=\"overflow-x-auto\">\n          <table className=\"min-w-full text-right\">\n            <thead className=\"bg-primary-50 text-sm text-primary-700\">\n              <tr>\n                <th className=\"px-4 py-3\">الطالب</th>\n                <th className=\"px-4 py-3\">المستوى</th>\n                <th className=\"px-4 py-3\">الحالة</th>\n              </tr>\n            </thead>\n            <tbody>\n              {students.map((student) => {\n                const current = statusMap[student.id] ?? \"present\";\n\n                return (\n                  <tr key={student.id} className=\"border-t border-gray-100\">\n                    <td className=\"px-4 py-3 font-semibold text-gray-900\">{student.full_name}</td>\n                    <td className=\"px-4 py-3 text-gray-700\">{student.level}</td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex flex-wrap justify-end gap-2\">\n                        {([\"present\", \"absent\", \"late\", \"excused\"] as AttendanceStatus[]).map((status) => (\n                          <button\n                            key={`${student.id}-${status}`}\n                            type=\"button\"\n                            onClick={() => setStatus(student.id, status)}\n                            className={`min-h-[44px] rounded-lg px-3 py-2 text-sm font-semibold ${\n                              current === status\n                                ? \"bg-primary-600 text-white\"\n                                : \"bg-primary-50 text-primary-700 hover:bg-primary-100\"\n                            }`}\n                          >\n                            {statusLabels[status]}\n                          </button>\n                        ))}\n                      </div>\n                    </td>\n                  </tr>\n                );\n              })}\n            </tbody>\n          </table>\n        </div>\n      </section>\n\n      <div className=\"flex justify-end\">\n        <button\n          type=\"button\"\n          disabled={!canSave || saving}\n          onClick={() => {\n            void saveAttendance();\n          }}\n          className=\"min-h-[44px] rounded-lg bg-primary-600 px-6 py-2 text-white hover:bg-primary-700 disabled:cursor-not-allowed disabled:opacity-50\"\n        >\n          {saving ? \"جارٍ الحفظ...\" : canSave ? \"حفظ الحضور\" : \"قراءة فقط\"}\n        </button>\n      </div>\n    </section>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}