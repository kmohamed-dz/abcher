(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[566],{1337:(e,r,t)=>{"use strict";t.d(r,{A_:()=>d,Yq:()=>o,cn:()=>a,r6:()=>n});var l=t(9722),s=t(622);function a(...e){return(0,s.QP)((0,l.$)(e))}function i(e){return e instanceof Date?e:new Date(e)}function o(e){let r=i(e);return Number.isNaN(r.getTime())?"-":new Intl.DateTimeFormat("ar-DZ",{year:"numeric",month:"long",day:"numeric"}).format(r)}function n(e){let r=i(e);return Number.isNaN(r.getTime())?"-":new Intl.DateTimeFormat("ar-DZ",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(r)}let d=["المبتدئ","جزء عم","جزء تبارك","ثلث القرآن","نصف القرآن","ثلاثة أرباع القرآن","الحفظ الكامل"]},1929:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>x});var l=t(5155),s=t(2115),a=t(3321),i=t(8434),o=t(4206),n=t(4426),d=t(8992),c=t(3602),u=t(7236),m=t(5446);let h=(0,u.U)();function f(e,r){if(e instanceof Error&&e.message)return e.message;if("object"==typeof e&&null!==e&&"message"in e){let r=e.message;if("string"==typeof r&&r.trim())return r}return r}function x(){let e=(0,a.useRouter)(),r=(0,s.useRef)(!1),[t,u]=(0,s.useState)(!0),[x,b]=(0,s.useState)(!1),[p,g]=(0,s.useState)(null),[y,w]=(0,s.useState)(null),[j,N]=(0,s.useState)(""),[v,_]=(0,s.useState)(""),[A,C]=(0,s.useState)(""),[S,k]=(0,s.useState)("");(0,s.useEffect)(()=>{r.current||(r.current=!0,(async()=>{u(!0);try{let{user:r,profile:t}=await (0,m.R)();if(!r)return void e.replace("/login");let l={id:r.id,full_name:t?.full_name??null,role:t?.role??null,school_id:t?.school_id??null};if(g(l),l.role&&l.school_id)return void e.replace("/dashboard");w(l.role??null)}catch(r){let e=f(r,"تعذر تحميل بيانات الإعداد.");console.warn("[auth:onboarding-load]",e),i.Ay.error(`تعذر تحميل بيانات الإعداد. (${e})`,{id:"onboarding-load-error"})}finally{u(!1)}})())},[e]);let D=(0,s.useMemo)(()=>y?"school_admin"===y?"create_school":"join_school":"role",[y]),F=async e=>{if(p){b(!0);try{let{error:r}=await h.from("profiles").upsert([{id:p.id,full_name:(p.full_name??"").trim(),role:e}],{onConflict:"id"});if(r)throw r;w(e),g(r=>r?{...r,role:e}:r),i.Ay.success("تم حفظ نوع الحساب.")}catch(r){let e=f(r,"تعذر حفظ نوع الحساب.");console.warn("[auth:onboarding-role]",e),i.Ay.error(`تعذر حفظ نوع الحساب. (${e})`)}finally{b(!1)}}},P=async r=>{if(r.preventDefault(),p){if(!j.trim()||!v.trim())return void i.Ay.error("اسم المدرسة والولاية مطلوبان.");b(!0);try{let r=Math.random().toString(36).slice(2,8).toUpperCase(),{data:t,error:l}=await h.from("schools").insert([{name:j.trim(),wilaya:v.trim(),address:A.trim()||null,school_code:r}]).select("id").single();if(l)throw l;let{error:s}=await h.from("profiles").update({school_id:t.id,role:y??"school_admin",full_name:(p.full_name??"").trim()}).eq("id",p.id);if(s)throw s;i.Ay.success("تم إنشاء المدرسة وربط الحساب بنجاح."),e.replace("/dashboard")}catch(r){let e=f(r,"تعذر إنشاء المدرسة.");console.warn("[auth:onboarding-create-school]",e),i.Ay.error(`تعذر إنشاء المدرسة. (${e})`)}finally{b(!1)}}},E=async r=>{if(r.preventDefault(),p){if(!S.trim())return void i.Ay.error("أدخل رمز المدرسة أولًا.");b(!0);try{let r=S.trim().toUpperCase(),{data:t,error:l}=await h.from("schools").select("id").eq("school_code",r).single();if(l||!t)throw Error("رمز المدرسة غير صحيح.");let{error:s}=await h.from("profiles").update({school_id:t.id,role:y??"teacher",full_name:(p.full_name??"").trim()}).eq("id",p.id);if(s)throw s;i.Ay.success("تم ربط الحساب بالمدرسة."),e.replace("/dashboard")}catch(r){let e=f(r,"تعذر ربط الحساب بالمدرسة.");console.warn("[auth:onboarding-join-school]",e),i.Ay.error(`تعذر ربط الحساب بالمدرسة. (${e})`)}finally{b(!1)}}};return t?(0,l.jsx)("section",{dir:"rtl",className:"flex min-h-screen items-center justify-center bg-app",children:(0,l.jsx)("div",{className:"h-11 w-11 animate-spin rounded-full border-4 border-primary-100 border-t-primary-600"})}):(0,l.jsxs)(o.A,{title:"إعداد الحساب",subtitle:"أكمل هذه الخطوات للمتابعة إلى لوحة التحكم",children:["role"===D?(0,l.jsxs)("div",{className:"space-y-3",dir:"rtl",children:[(0,l.jsxs)(d.A,{className:"space-y-2 border border-primary-100 bg-white p-4",children:[(0,l.jsx)("h3",{className:"font-bold text-gray-900",children:"مدير مدرسة"}),(0,l.jsx)("p",{className:"text-sm text-gray-600",children:"إنشاء مدرسة جديدة وإدارة جميع بياناتها."}),(0,l.jsx)(n.A,{disabled:x,onClick:()=>{F("school_admin")},children:"اختيار مدير مدرسة"})]}),(0,l.jsxs)(d.A,{className:"space-y-2 border border-primary-100 bg-white p-4",children:[(0,l.jsx)("h3",{className:"font-bold text-gray-900",children:"معلم / ولي / طالب"}),(0,l.jsx)("p",{className:"text-sm text-gray-600",children:"الانضمام إلى مدرسة موجودة عبر رمز المدرسة."}),(0,l.jsx)(n.A,{disabled:x,onClick:()=>{F("teacher")},children:"الانضمام إلى مدرسة"})]})]}):null,"create_school"===D?(0,l.jsxs)("form",{onSubmit:P,className:"space-y-4",dir:"rtl",children:[(0,l.jsx)(c.A,{id:"school-name",label:"اسم المدرسة",value:j,onChange:N}),(0,l.jsx)(c.A,{id:"school-wilaya",label:"الولاية",value:v,onChange:_}),(0,l.jsx)(c.A,{id:"school-address",label:"العنوان (اختياري)",value:A,onChange:C}),(0,l.jsx)(n.A,{type:"submit",disabled:x,children:x?"جارٍ إنشاء المدرسة...":"إنشاء المدرسة"})]}):null,"join_school"===D?(0,l.jsxs)("form",{onSubmit:E,className:"space-y-4",dir:"rtl",children:[(0,l.jsx)(c.A,{id:"join-code",label:"رمز المدرسة",value:S,onChange:e=>k(e.toUpperCase()),helper:"الرمز مكوّن من 6 أحرف تقريبًا"}),(0,l.jsx)(n.A,{type:"submit",disabled:x,children:x?"جارٍ الربط...":"ربط الحساب"})]}):null]})}},2525:(e,r,t)=>{Promise.resolve().then(t.bind(t,1929))},3321:(e,r,t)=>{"use strict";var l=t(4645);t.o(l,"useParams")&&t.d(r,{useParams:function(){return l.useParams}}),t.o(l,"usePathname")&&t.d(r,{usePathname:function(){return l.usePathname}}),t.o(l,"useRouter")&&t.d(r,{useRouter:function(){return l.useRouter}})},3602:(e,r,t)=>{"use strict";t.d(r,{A:()=>a});var l=t(5155),s=t(1337);function a({id:e,label:r,value:t,error:a,helper:i,onChange:o,className:n,...d}){return(0,l.jsxs)("div",{className:"space-y-1.5",children:[(0,l.jsx)("label",{htmlFor:e,className:"block text-sm font-semibold text-gray-700",children:r}),(0,l.jsx)("input",{id:e,value:t,onChange:e=>o(e.target.value),className:(0,s.cn)("min-h-[44px] w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-[16px] outline-none ring-brand-600/20 transition focus:ring",a?"border-red-300":"",n),...d}),a?(0,l.jsx)("p",{className:"text-sm text-red-600",children:a}):i?(0,l.jsx)("p",{className:"text-xs text-gray-500",children:i}):null]})}},4206:(e,r,t)=>{"use strict";t.d(r,{A:()=>o});var l=t(5155),s=t(8500),a=t.n(s),i=t(8992);function o({title:e,subtitle:r,children:t,footer:s}){return(0,l.jsx)("main",{dir:"rtl",className:"min-h-screen bg-app",children:(0,l.jsxs)("div",{className:"grid min-h-screen lg:grid-cols-2",children:[(0,l.jsx)("section",{className:"relative overflow-hidden bg-brand-600 bg-mosque-pattern p-6 text-white lg:p-10",children:(0,l.jsxs)("div",{className:"mx-auto flex h-full w-full max-w-xl flex-col justify-between",children:[(0,l.jsxs)("div",{className:"rounded-2xl bg-white/10 p-4 backdrop-blur-sm",children:[(0,l.jsx)("p",{className:"text-sm text-white/90",children:"منصة المدارس القرآنية"}),(0,l.jsx)("h2",{className:"mt-2 text-2xl font-extrabold",children:"إدارة مدرسية بطابع عربي واضح"})]}),(0,l.jsxs)("div",{className:"relative hidden h-64 lg:block",children:[(0,l.jsx)("div",{className:"absolute bottom-0 right-0 h-40 w-40 rounded-t-full border-2 border-white/25"}),(0,l.jsx)("div",{className:"absolute bottom-0 right-20 h-56 w-56 rounded-t-full border-2 border-white/20"}),(0,l.jsx)("div",{className:"absolute bottom-0 right-44 h-32 w-32 rounded-t-full border-2 border-white/20"}),(0,l.jsx)("div",{className:"absolute bottom-0 left-12 h-20 w-16 rounded-t-full bg-white/10"}),(0,l.jsx)("div",{className:"absolute bottom-20 left-[5.25rem] h-8 w-2 bg-white/30"})]})]})}),(0,l.jsxs)("section",{className:"relative flex items-center justify-center px-4 py-8 md:px-8",children:[(0,l.jsx)(a(),{href:"/",className:"absolute right-6 top-6 text-xl font-extrabold text-brand-700",children:"أبشر"}),(0,l.jsxs)(i.A,{className:"w-full max-w-[480px] bg-[#FFFCF7] p-6 md:p-8",children:[(0,l.jsxs)("header",{className:"mb-6 space-y-2 text-center",children:[(0,l.jsx)("h1",{className:"text-2xl font-extrabold text-brand-700 md:text-3xl",children:e}),r?(0,l.jsx)("p",{className:"text-sm leading-7 text-gray-600",children:r}):null]}),(0,l.jsx)("div",{className:"space-y-4",children:t}),s?(0,l.jsx)("footer",{className:"mt-6 text-center text-sm text-gray-600",children:s}):null]})]})]})})}},4426:(e,r,t)=>{"use strict";t.d(r,{A:()=>i});var l=t(5155),s=t(1337);let a={primary:"bg-brand-600 text-white hover:bg-brand-700",secondary:"bg-white text-brand-700 border border-brand-600 hover:bg-primary-50",danger:"bg-red-600 text-white hover:bg-red-700"};function i({variant:e="primary",className:r,type:t="button",...i}){return(0,l.jsx)("button",{type:t,className:(0,s.cn)("inline-flex min-h-[44px] w-full items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold transition disabled:cursor-not-allowed disabled:opacity-60",a[e],r),...i})}},5446:(e,r,t)=>{"use strict";t.d(r,{R:()=>i});let l=(0,t(7236).U)();function s(e){let r=e.toLowerCase();return r.includes("row-level security")||r.includes("permission denied")||r.includes("not allowed")}async function a(e){return l.from("profiles").select("id,full_name,role,school_id,phone,avatar_url").eq("id",e).maybeSingle()}async function i(){let e,{data:{user:r},error:t}=await l.auth.getUser();if(t)throw t;if(!r)return{user:null,profile:null};let i=await a(r.id);if(i.error){if(s(i.error.message))return{user:r,profile:null};throw i.error}if(i.data)return{user:r,profile:i.data};let{error:o}=await l.from("profiles").upsert([{id:r.id,full_name:"string"==typeof(e=r.user_metadata?.full_name)&&e.trim()?e.trim():r.email&&r.email.split("@")[0]||""}],{onConflict:"id"});if(o){if(s(o.message))return{user:r,profile:null};throw o}let n=await a(r.id);if(n.error){if(s(n.error.message))return{user:r,profile:null};throw n.error}return{user:r,profile:n.data??null}}},7236:(e,r,t)=>{"use strict";t.d(r,{U:()=>s});var l=t(6622);function s(){return(0,l.createBrowserClient)("https://zuppzhysrgmioyozrltp.supabase.co","sb_publishable_GQkKFgomb7ThK_H_csmdoQ_CYQOschE")}},8992:(e,r,t)=>{"use strict";t.d(r,{A:()=>a});var l=t(5155),s=t(1337);function a({className:e,...r}){return(0,l.jsx)("div",{className:(0,s.cn)("rounded-3xl bg-white p-6 shadow-card",e),...r})}}},e=>{e.O(0,[143,500,409,441,794,358],()=>e(e.s=2525)),_N_E=e.O()}]);