(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[631],{3152:(e,r,a)=>{"use strict";a.r(r),a.d(r,{default:()=>d});var l=a(5155),s=a(8500),t=a.n(s),i=a(2115),o=a(8434);let n=(0,a(7236).U)();function d(){let[e,r]=(0,i.useState)(!0),[a,s]=(0,i.useState)(!1),[d,c]=(0,i.useState)(!1),[m,h]=(0,i.useState)(!1),[u,x]=(0,i.useState)(null),[p,y]=(0,i.useState)(null),[g,f]=(0,i.useState)({}),[b,w]=(0,i.useState)({full_name:"",phone:"",avatar_url:""}),[j,_]=(0,i.useState)({name:"",wilaya:"",address:""}),v=(0,i.useCallback)(async()=>{r(!0);try{let{data:{user:e}}=await n.auth.getUser();if(!e)throw Error("يرجى تسجيل الدخول أولًا.");let{data:r,error:a}=await n.from("profiles").select("id,full_name,phone,avatar_url,school_id,role").eq("id",e.id).single();if(a)throw a;if(x(r),w({full_name:r.full_name||"",phone:r.phone||"",avatar_url:r.avatar_url||""}),"school_admin"===r.role&&r.school_id){let{data:e,error:a}=await n.from("schools").select("id,name,wilaya,address").eq("id",r.school_id).single();if(a)throw a;y(e),_({name:e.name||"",wilaya:e.wilaya||"",address:e.address||""})}else y(null)}catch(r){let e=r instanceof Error?r.message:"تعذر تحميل الإعدادات.";o.Ay.error(e)}finally{r(!1)}},[]);(0,i.useEffect)(()=>{v()},[v]);let N=async()=>{let e;if(!u||(e={},b.full_name.trim()||(e.full_name="الاسم الكامل مطلوب."),f(r=>({...r,...e})),0!==Object.keys(e).length))return void o.Ay.error("تحقق من بيانات الملف الشخصي.");s(!0);try{let e=n.from("profiles").update({full_name:b.full_name.trim(),phone:b.phone.trim()||null}).eq("id",u.id);u.school_id&&(e=e.eq("school_id",u.school_id));let{error:r}=await e;if(r)throw r;o.Ay.success("تم حفظ الملف الشخصي."),await v()}catch(r){let e=r instanceof Error?r.message:"تعذر حفظ الملف الشخصي.";o.Ay.error(e)}finally{s(!1)}},k=async()=>{let e;if(!u?.school_id||!p||(e={},j.name.trim()||(e.school_name="اسم المدرسة مطلوب."),j.wilaya.trim()||(e.school_wilaya="الولاية مطلوبة."),f(r=>({...r,...e})),0!==Object.keys(e).length))return void o.Ay.error("تحقق من بيانات المدرسة.");c(!0);try{let{error:e}=await n.from("schools").update({name:j.name.trim(),wilaya:j.wilaya.trim(),address:j.address.trim()||null}).eq("id",u.school_id);if(e)throw e;o.Ay.success("تم حفظ إعدادات المدرسة."),await v()}catch(r){let e=r instanceof Error?r.message:"تعذر حفظ إعدادات المدرسة.";o.Ay.error(e)}finally{c(!1)}},C=async e=>{if(!u)return void o.Ay.error("تعذر معرفة المستخدم الحالي.");h(!0);try{let r=e.name.includes(".")&&e.name.split(".").pop()||"png",a=`${u.id}/${Date.now()}-avatar.${r}`,{error:l}=await n.storage.from("avatars").upload(a,e,{upsert:!0});if(l)throw l;let{data:s}=n.storage.from("avatars").getPublicUrl(a),t=s.publicUrl,i=n.from("profiles").update({avatar_url:t}).eq("id",u.id);u.school_id&&(i=i.eq("school_id",u.school_id));let{error:d}=await i;if(d)throw d;w(e=>({...e,avatar_url:t})),o.Ay.success("تم رفع الصورة الشخصية."),await v()}catch(r){let e=r instanceof Error?r.message:"تعذر رفع الصورة.";o.Ay.error(e)}finally{h(!1)}};return e?(0,l.jsx)("section",{dir:"rtl",className:"flex min-h-[65vh] items-center justify-center",children:(0,l.jsx)("div",{className:"h-11 w-11 animate-spin rounded-full border-4 border-primary-100 border-t-primary-600"})}):u?(0,l.jsxs)("section",{dir:"rtl",className:"space-y-5",children:[(0,l.jsxs)("header",{className:"rounded-xl bg-white p-6 shadow-md",children:[(0,l.jsx)("h1",{className:"text-2xl font-bold text-primary-700",children:"الإعدادات"}),(0,l.jsx)("p",{className:"mt-2 text-gray-600",children:"إدارة الملف الشخصي وإعدادات المدرسة."})]}),(0,l.jsxs)("section",{className:"rounded-xl bg-white p-6 shadow-md",children:[(0,l.jsx)("h2",{className:"mb-4 text-xl font-bold text-primary-700",children:"الملف الشخصي"}),(0,l.jsxs)("div",{className:"mb-4 flex flex-col gap-3 md:flex-row md:items-center",children:[(0,l.jsx)("img",{src:b.avatar_url||"/placeholder.svg",alt:"الصورة الشخصية",className:"h-20 w-20 rounded-full border border-primary-100 object-cover"}),(0,l.jsxs)("label",{className:"inline-flex min-h-[44px] cursor-pointer items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:[m?"جارٍ الرفع...":"رفع صورة",(0,l.jsx)("input",{type:"file",accept:"image/*",className:"hidden",onChange:e=>{let r=e.target.files?.[0];r&&C(r),e.target.value=""},disabled:m})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{htmlFor:"full-name",className:"mb-1 block text-sm font-semibold text-gray-700",children:"الاسم الكامل"}),(0,l.jsx)("input",{id:"full-name",value:b.full_name,onChange:e=>w(r=>({...r,full_name:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"}),g.full_name?(0,l.jsx)("p",{className:"mt-1 text-sm text-red-600",children:g.full_name}):null]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{htmlFor:"phone",className:"mb-1 block text-sm font-semibold text-gray-700",children:"الهاتف"}),(0,l.jsx)("input",{id:"phone",value:b.phone,onChange:e=>w(r=>({...r,phone:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"})]})]}),(0,l.jsx)("div",{className:"mt-4 flex justify-end",children:(0,l.jsx)("button",{type:"button",disabled:a,onClick:()=>{N()},className:"min-h-[44px] rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700 disabled:opacity-60",children:a?"جارٍ الحفظ...":"حفظ الملف الشخصي"})})]}),"school_admin"===u.role?(0,l.jsxs)("section",{className:"rounded-xl bg-white p-6 shadow-md",children:[(0,l.jsx)("h2",{className:"mb-4 text-xl font-bold text-primary-700",children:"إعدادات المدرسة"}),p?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{htmlFor:"school-name",className:"mb-1 block text-sm font-semibold text-gray-700",children:"اسم المدرسة"}),(0,l.jsx)("input",{id:"school-name",value:j.name,onChange:e=>_(r=>({...r,name:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"}),g.school_name?(0,l.jsx)("p",{className:"mt-1 text-sm text-red-600",children:g.school_name}):null]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{htmlFor:"school-wilaya",className:"mb-1 block text-sm font-semibold text-gray-700",children:"الولاية"}),(0,l.jsx)("input",{id:"school-wilaya",value:j.wilaya,onChange:e=>_(r=>({...r,wilaya:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"}),g.school_wilaya?(0,l.jsx)("p",{className:"mt-1 text-sm text-red-600",children:g.school_wilaya}):null]}),(0,l.jsxs)("div",{className:"md:col-span-2",children:[(0,l.jsx)("label",{htmlFor:"school-address",className:"mb-1 block text-sm font-semibold text-gray-700",children:"العنوان"}),(0,l.jsx)("input",{id:"school-address",value:j.address,onChange:e=>_(r=>({...r,address:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"})]})]}),(0,l.jsx)("div",{className:"mt-4 flex justify-end",children:(0,l.jsx)("button",{type:"button",disabled:d,onClick:()=>{k()},className:"min-h-[44px] rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700 disabled:opacity-60",children:d?"جارٍ الحفظ...":"حفظ إعدادات المدرسة"})})]}):(0,l.jsxs)("div",{className:"rounded-lg border border-dashed border-primary-200 bg-primary-50 p-6 text-center",children:[(0,l.jsx)("p",{className:"mb-4 text-gray-600",children:"لا توجد بيانات مدرسة مرتبطة بحسابك."}),(0,l.jsx)(t(),{href:"/onboarding",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"إكمال بيانات المدرسة"})]})]}):null]}):(0,l.jsxs)("section",{dir:"rtl",className:"rounded-xl bg-white p-6 text-center shadow-md",children:[(0,l.jsx)("h1",{className:"mb-3 text-2xl font-bold text-primary-700",children:"تعذر تحميل الإعدادات"}),(0,l.jsx)("p",{className:"mb-6 text-gray-600",children:"حاول تسجيل الدخول من جديد."}),(0,l.jsx)(t(),{href:"/login",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"تسجيل الدخول"})]})}},7236:(e,r,a)=>{"use strict";a.d(r,{U:()=>s});var l=a(6622);function s(){return(0,l.createBrowserClient)("https://zuppzhysrgmioyozrltp.supabase.co","sb_publishable_GQkKFgomb7ThK_H_csmdoQ_CYQOschE")}},9704:(e,r,a)=>{Promise.resolve().then(a.bind(a,3152))}},e=>{e.O(0,[143,500,441,794,358],()=>e(e.s=9704)),_N_E=e.O()}]);