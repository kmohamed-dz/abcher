(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[342],{1337:(e,r,t)=>{"use strict";t.d(r,{A_:()=>c,Yq:()=>n,cn:()=>a,r6:()=>d});var s=t(9722),i=t(622);function a(...e){return(0,i.QP)((0,s.$)(e))}function l(e){return e instanceof Date?e:new Date(e)}function n(e){let r=l(e);return Number.isNaN(r.getTime())?"-":new Intl.DateTimeFormat("ar-DZ",{year:"numeric",month:"long",day:"numeric"}).format(r)}function d(e){let r=l(e);return Number.isNaN(r.getTime())?"-":new Intl.DateTimeFormat("ar-DZ",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(r)}let c=["المبتدئ","جزء عم","جزء تبارك","ثلث القرآن","نصف القرآن","ثلاثة أرباع القرآن","الحفظ الكامل"]},7236:(e,r,t)=>{"use strict";t.d(r,{U:()=>i});var s=t(6622);function i(){return(0,s.createBrowserClient)("https://zuppzhysrgmioyozrltp.supabase.co","sb_publishable_GQkKFgomb7ThK_H_csmdoQ_CYQOschE")}},7867:(e,r,t)=>{Promise.resolve().then(t.bind(t,9961))},9961:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>m});var s=t(5155),i=t(8500),a=t.n(i),l=t(2115),n=t(8434),d=t(7236),c=t(1337);let o=(0,d.U)();function m(){let[e,r]=(0,l.useState)(!0),[t,i]=(0,l.useState)(!1),[d,m]=(0,l.useState)(null),[h,u]=(0,l.useState)(""),[x,p]=(0,l.useState)("مستخدم"),[f,g]=(0,l.useState)([]),[y,b]=(0,l.useState)(""),[_,j]=(0,l.useState)([]),[N,w]=(0,l.useState)(""),v=(0,l.useRef)(null),E=(0,l.useMemo)(()=>f.find(e=>e.id===y)??null,[y,f]),$=(0,l.useCallback)(async()=>{r(!0);try{let{data:{user:e}}=await o.auth.getUser();if(!e)throw Error("يرجى تسجيل الدخول أولًا.");u(e.id);let{data:r,error:t}=await o.from("profiles").select("school_id, full_name").eq("id",e.id).single();if(t)throw t;if(!r?.school_id){m(null),g([]),j([]);return}m(r.school_id),p(r.full_name||"مستخدم");let{data:s,error:i}=await o.from("profiles").select("id, full_name, role").eq("school_id",r.school_id).neq("id",e.id).order("full_name",{ascending:!0});if(i)throw i;let a=(s??[]).map(e=>({id:e.id,full_name:e.full_name||"مستخدم",role:e.role}));g(a),b(e=>e||a[0]?.id||"")}catch(r){let e=r instanceof Error?r.message:"تعذر تحميل الرسائل.";n.Ay.error(e)}finally{r(!1)}},[]),k=(0,l.useCallback)(async()=>{if(!d||!h||!y)return void j([]);try{let e=`and(sender_id.eq.${h},receiver_id.eq.${y}),and(sender_id.eq.${y},receiver_id.eq.${h})`,{data:r,error:t}=await o.from("messages").select("id,school_id,sender_id,receiver_id,content,created_at").eq("school_id",d).or(e).order("created_at",{ascending:!0});if(t)throw t;j(r??[])}catch(r){let e=r instanceof Error?r.message:"تعذر تحميل المحادثة.";n.Ay.error(e)}},[d,h,y]);(0,l.useEffect)(()=>{$()},[$]),(0,l.useEffect)(()=>{k()},[k]),(0,l.useEffect)(()=>{if(!d)return;let e=o.channel(`messages-${d}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`school_id=eq.${d}`},e=>{let r=e.new;(r.sender_id===h&&r.receiver_id===y||r.sender_id===y&&r.receiver_id===h)&&j(e=>e.some(e=>e.id===r.id)?e:[...e,r])}).subscribe();return()=>{o.removeChannel(e)}},[d,h,y]),(0,l.useEffect)(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[_]);let q=async()=>{let e=N.trim();if(!e)return void n.Ay.error("اكتب الرسالة أولًا.");if(!d||!y)return void n.Ay.error("اختر محادثة أولًا.");i(!0);try{let{error:r}=await o.from("messages").insert([{school_id:d,sender_id:h,receiver_id:y,content:e,sender_name:x}]);if(r)throw r;w("")}catch(r){let e=r instanceof Error?r.message:"تعذر إرسال الرسالة.";n.Ay.error(e)}finally{i(!1)}};return e?(0,s.jsx)("section",{dir:"rtl",className:"flex min-h-[65vh] items-center justify-center",children:(0,s.jsx)("div",{className:"h-11 w-11 animate-spin rounded-full border-4 border-primary-100 border-t-primary-600"})}):d?(0,s.jsxs)("section",{dir:"rtl",className:"space-y-5",children:[(0,s.jsxs)("header",{className:"rounded-xl bg-white p-6 shadow-md",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-primary-700",children:"الرسائل"}),(0,s.jsx)("p",{className:"mt-2 text-gray-600",children:"تواصل مباشر داخل المدرسة في الوقت الحقيقي."})]}),(0,s.jsxs)("section",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[(0,s.jsxs)("aside",{className:"rounded-xl bg-white p-4 shadow-md lg:col-span-1",children:[(0,s.jsx)("h2",{className:"mb-3 text-lg font-bold text-primary-700",children:"المحادثات"}),0===f.length?(0,s.jsxs)("div",{className:"rounded-lg border border-dashed border-primary-200 bg-primary-50 p-4 text-center",children:[(0,s.jsx)("p",{className:"mb-3 text-sm text-gray-600",children:"لا يوجد مستخدمون ضمن المدرسة."}),(0,s.jsx)(a(),{href:"/dashboard/settings",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-sm text-white hover:bg-primary-700",children:"تحديث الإعدادات"})]}):(0,s.jsx)("ul",{className:"space-y-2",children:f.map(e=>(0,s.jsx)("li",{children:(0,s.jsxs)("button",{type:"button",onClick:()=>b(e.id),className:`w-full min-h-[44px] rounded-lg px-3 py-2 text-right ${y===e.id?"bg-primary-600 text-white":"bg-beige-50 text-gray-800 hover:bg-primary-50"}`,children:[(0,s.jsx)("p",{className:"font-semibold",children:e.full_name}),(0,s.jsx)("p",{className:`text-xs ${y===e.id?"text-primary-100":"text-gray-500"}`,children:e.role||"مستخدم"})]})},e.id))})]}),(0,s.jsx)("div",{className:"rounded-xl bg-white p-4 shadow-md lg:col-span-2",children:E?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-3 border-b border-gray-100 pb-3",children:[(0,s.jsx)("p",{className:"font-bold text-primary-700",children:E.full_name}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:E.role||"مستخدم"})]}),(0,s.jsxs)("div",{className:"h-[420px] space-y-3 overflow-y-auto rounded-lg bg-beige-50 p-3",children:[0===_.length?(0,s.jsx)("div",{className:"flex h-full items-center justify-center text-center text-gray-600",children:"لا توجد رسائل في هذه المحادثة بعد."}):_.map(e=>{let r=e.sender_id===h;return(0,s.jsx)("article",{className:`flex ${r?"justify-start":"justify-end"}`,children:(0,s.jsxs)("div",{className:`max-w-[80%] rounded-xl px-4 py-3 text-sm ${r?"bg-primary-600 text-white":"bg-white text-gray-800"}`,children:[(0,s.jsx)("p",{className:"leading-7",children:e.content}),(0,s.jsx)("p",{className:`mt-1 text-xs ${r?"text-primary-100":"text-gray-500"}`,children:(0,c.r6)(e.created_at)})]})},e.id)}),(0,s.jsx)("div",{ref:v})]}),(0,s.jsxs)("div",{className:"mt-3 flex flex-col gap-2 sm:flex-row",children:[(0,s.jsx)("input",{type:"text",value:N,onChange:e=>w(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),q())},className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring",placeholder:"اكتب رسالتك هنا"}),(0,s.jsx)("button",{type:"button",disabled:t,onClick:()=>{q()},className:"min-h-[44px] rounded-lg bg-primary-600 px-5 py-2 text-white hover:bg-primary-700 disabled:opacity-60",children:t?"جارٍ الإرسال...":"إرسال"})]})]}):(0,s.jsx)("div",{className:"flex h-[420px] items-center justify-center rounded-lg bg-beige-50 text-center text-gray-600",children:"اختر محادثة من القائمة لعرض الرسائل."})})]})]}):(0,s.jsxs)("section",{dir:"rtl",className:"rounded-xl bg-white p-6 text-center shadow-md",children:[(0,s.jsx)("h1",{className:"mb-3 text-2xl font-bold text-primary-700",children:"لا توجد مدرسة مرتبطة"}),(0,s.jsx)("p",{className:"mb-6 text-gray-600",children:"أكمل الإعداد حتى تتمكن من استخدام الرسائل."}),(0,s.jsx)(a(),{href:"/onboarding",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"إكمال الإعداد"})]})}}},e=>{e.O(0,[143,500,409,441,794,358],()=>e(e.s=7867)),_N_E=e.O()}]);