(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[824],{515:(e,t,r)=>{Promise.resolve().then(r.bind(r,2671))},1337:(e,t,r)=>{"use strict";r.d(t,{A_:()=>o,Yq:()=>n,cn:()=>a,r6:()=>d});var s=r(9722),l=r(622);function a(...e){return(0,l.QP)((0,s.$)(e))}function i(e){return e instanceof Date?e:new Date(e)}function n(e){let t=i(e);return Number.isNaN(t.getTime())?"-":new Intl.DateTimeFormat("ar-DZ",{year:"numeric",month:"long",day:"numeric"}).format(t)}function d(e){let t=i(e);return Number.isNaN(t.getTime())?"-":new Intl.DateTimeFormat("ar-DZ",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(t)}let o=["المبتدئ","جزء عم","جزء تبارك","ثلث القرآن","نصف القرآن","ثلاثة أرباع القرآن","الحفظ الكامل"]},1914:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});let s=(0,r(2806).A)("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},2671:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>y});var s=r(5155),l=r(2115),a=r(1914),i=r(8434),n=r(3210),d=r(7236),o=r(1337);let c=(0,d.U)(),m={title:"",exam_date:new Date().toISOString().slice(0,10),max_score:"20",level:o.A_[0]};function x({isOpen:e,onClose:t,onSuccess:r,schoolId:a,exam:d}){let[x,u]=(0,l.useState)(m),[h,p]=(0,l.useState)({}),[y,g]=(0,l.useState)(!1);if((0,l.useEffect)(()=>{e&&(d?u({title:d.title,exam_date:d.exam_date,max_score:String(d.max_score),level:d.level}):u(m),p({}))},[e,d]),!e)return null;let b=async()=>{let e,t;if(e={},x.title.trim()||(e.title="عنوان الاختبار مطلوب."),x.exam_date||(e.exam_date="تاريخ الاختبار مطلوب."),(!Number.isFinite(t=Number(x.max_score))||t<=0)&&(e.max_score="الدرجة القصوى يجب أن تكون رقمًا أكبر من صفر."),p(e),0!==Object.keys(e).length)return void i.Ay.error("تحقق من بيانات الاختبار.");if(!a)return void i.Ay.error("تعذر معرفة المدرسة الحالية.");g(!0);try{let e={title:x.title.trim(),exam_date:x.exam_date,max_score:Number(x.max_score),level:x.level};if(d){let{error:t}=await c.from("exams").update(e).eq("id",d.id).eq("school_id",a);if(t)throw t;i.Ay.success("تم تعديل الاختبار.")}else{let{error:t}=await c.from("exams").insert([{school_id:a,...e}]);if(t)throw t;i.Ay.success("تمت إضافة الاختبار.")}r()}catch(t){let e=t instanceof Error?t.message:"تعذر حفظ الاختبار.";i.Ay.error(e)}finally{g(!1)}};return(0,s.jsx)("div",{dir:"rtl",role:"presentation",onClick:e=>{e.target===e.currentTarget&&t()},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:(0,s.jsxs)("div",{className:"w-full max-w-xl rounded-xl bg-white p-6 shadow-md",children:[(0,s.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,s.jsx)("h2",{className:"text-xl font-bold text-primary-700",children:d?"تعديل اختبار":"إضافة اختبار"}),(0,s.jsx)("button",{type:"button",onClick:t,"aria-label":"إغلاق",className:"inline-flex h-9 w-9 items-center justify-center rounded-full border border-gray-200 text-gray-600 hover:bg-gray-100",children:(0,s.jsx)(n.A,{className:"h-4 w-4"})})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"exam-title",className:"mb-1 block text-sm font-semibold text-gray-700",children:"عنوان الاختبار"}),(0,s.jsx)("input",{id:"exam-title",value:x.title,onChange:e=>u(t=>({...t,title:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"}),h.title?(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:h.title}):null]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"exam-level",className:"mb-1 block text-sm font-semibold text-gray-700",children:"المستوى"}),(0,s.jsx)("select",{id:"exam-level",value:x.level,onChange:e=>u(t=>({...t,level:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring",children:o.A_.map(e=>(0,s.jsx)("option",{value:e,children:e},e))})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"exam-date",className:"mb-1 block text-sm font-semibold text-gray-700",children:"تاريخ الاختبار"}),(0,s.jsx)("input",{id:"exam-date",type:"date",value:x.exam_date,onChange:e=>u(t=>({...t,exam_date:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"}),h.exam_date?(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:h.exam_date}):null]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"exam-max-score",className:"mb-1 block text-sm font-semibold text-gray-700",children:"الدرجة القصوى"}),(0,s.jsx)("input",{id:"exam-max-score",type:"number",min:"1",value:x.max_score,onChange:e=>u(t=>({...t,max_score:e.target.value})),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"}),h.max_score?(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:h.max_score}):null]})]})]}),(0,s.jsxs)("div",{className:"mt-6 flex justify-end gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:t,className:"min-h-[44px] rounded-lg border border-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-100",children:"إلغاء"}),(0,s.jsx)("button",{type:"button",disabled:y,onClick:()=>{b()},className:"min-h-[44px] rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700 disabled:opacity-60",children:y?"جارٍ الحفظ...":"حفظ"})]})]})})}let u=(0,d.U)();function h({isOpen:e,onClose:t,onSuccess:r,schoolId:a,exam:d,students:o,canManage:c}){let[m,x]=(0,l.useState)(!1),[h,p]=(0,l.useState)(!1),[y,g]=(0,l.useState)({});(0,l.useEffect)(()=>{e&&a&&(async()=>{x(!0);try{let{data:e,error:t}=await u.from("results").select("student_id,score").eq("school_id",a).eq("exam_id",d.id);if(t)throw t;let r={};(e??[]).forEach(e=>{r[e.student_id]=String(e.score)}),g(r)}catch(t){let e=t instanceof Error?t.message:"تعذر تحميل درجات الاختبار.";i.Ay.error(e)}finally{x(!1)}})()},[e,a,d.id]);let b=(0,l.useMemo)(()=>Object.values(y).filter(e=>e.trim().length>0).length,[y]);if(!e)return null;let f=async()=>{if(!c)return void i.Ay.error("ليس لديك صلاحية تعديل النتائج.");if(!a)return void i.Ay.error("تعذر معرفة المدرسة الحالية.");let e=[];for(let t of o){let r=(y[t.id]||"").trim();if(!r)continue;let s=Number(r);if(!Number.isFinite(s)||s<0||s>d.max_score)return void i.Ay.error(`درجة غير صالحة للطالب ${t.full_name}.`);e.push({school_id:a,exam_id:d.id,student_id:t.id,score:s})}if(0===e.length)return void i.Ay.error("أدخل درجة واحدة على الأقل.");p(!0);try{let{error:t}=await u.from("results").upsert(e,{onConflict:"exam_id,student_id"});if(t)throw t;i.Ay.success("تم حفظ النتائج بنجاح."),r()}catch(t){let e=t instanceof Error?t.message:"تعذر حفظ النتائج.";i.Ay.error(e)}finally{p(!1)}};return(0,s.jsx)("div",{dir:"rtl",role:"presentation",onClick:e=>{e.target===e.currentTarget&&t()},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:(0,s.jsxs)("div",{className:"w-full max-w-4xl rounded-xl bg-white p-6 shadow-md",children:[(0,s.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h2",{className:"text-xl font-bold text-primary-700",children:["درجات الاختبار: ",d.title]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["المستوى: ",d.level," | الدرجة القصوى: ",d.max_score]})]}),(0,s.jsx)("button",{type:"button",onClick:t,"aria-label":"إغلاق",className:"inline-flex h-9 w-9 items-center justify-center rounded-full border border-gray-200 text-gray-600 hover:bg-gray-100",children:(0,s.jsx)(n.A,{className:"h-4 w-4"})})]}),m?(0,s.jsx)("div",{className:"flex min-h-[260px] items-center justify-center",children:(0,s.jsx)("div",{className:"h-11 w-11 animate-spin rounded-full border-4 border-primary-100 border-t-primary-600"})}):0===o.length?(0,s.jsxs)("div",{className:"rounded-lg border border-dashed border-primary-200 bg-primary-50 p-6 text-center",children:[(0,s.jsx)("p",{className:"mb-4 text-gray-600",children:"لا يوجد طلبة لإدخال النتائج."}),(0,s.jsx)("a",{href:"/dashboard/students",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"إضافة طلبة"})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("p",{className:"mb-3 text-sm text-gray-600",children:["عدد الدرجات المدخلة: ",b]}),(0,s.jsx)("div",{className:"max-h-[380px] overflow-y-auto rounded-lg border border-gray-100",children:(0,s.jsxs)("table",{className:"min-w-full text-right",children:[(0,s.jsx)("thead",{className:"bg-primary-50 text-sm text-primary-700",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3",children:"الطالب"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"المستوى"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"الدرجة"})]})}),(0,s.jsx)("tbody",{children:o.map(e=>(0,s.jsxs)("tr",{className:"border-t border-gray-100",children:[(0,s.jsx)("td",{className:"px-4 py-3 font-semibold text-gray-900",children:e.full_name}),(0,s.jsx)("td",{className:"px-4 py-3 text-gray-700",children:e.level}),(0,s.jsx)("td",{className:"px-4 py-3",children:(0,s.jsx)("input",{type:"number",min:"0",max:d.max_score,value:y[e.id]||"",onChange:t=>g(r=>({...r,[e.id]:t.target.value})),disabled:!c,className:"w-28 rounded-lg border border-gray-200 px-3 py-2 text-[16px] outline-none ring-primary-200 focus:ring disabled:bg-gray-100"})})]},e.id))})]})}),(0,s.jsxs)("div",{className:"mt-6 flex justify-end gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:t,className:"min-h-[44px] rounded-lg border border-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-100",children:"إغلاق"}),c?(0,s.jsx)("button",{type:"button",disabled:h,onClick:()=>{f()},className:"min-h-[44px] rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700 disabled:opacity-60",children:h?"جارٍ الحفظ...":"حفظ الدرجات"}):null]})]})]})})}let p=(0,d.U)();function y(){let[e,t]=(0,l.useState)(!0),[r,n]=(0,l.useState)(null),[d,c]=(0,l.useState)(null),[m,u]=(0,l.useState)([]),[y,g]=(0,l.useState)([]),[b,f]=(0,l.useState)(!1),[j,N]=(0,l.useState)(null),[w,v]=(0,l.useState)(!1),[_,k]=(0,l.useState)(null),C="school_admin"===d||"teacher"===d,A=(0,l.useCallback)(async()=>{t(!0);try{let{data:{user:e}}=await p.auth.getUser();if(!e)throw Error("يرجى تسجيل الدخول أولًا.");let{data:t,error:r}=await p.from("profiles").select("school_id, role").eq("id",e.id).single();if(r)throw r;if(c(t?.role??null),!t?.school_id){n(null),g([]),u([]);return}n(t.school_id);let[s,l]=await Promise.all([p.from("exams").select("id,school_id,title,exam_date,max_score,level,created_at").eq("school_id",t.school_id).order("exam_date",{ascending:!1}),p.from("students").select("id,school_id,full_name,level,parent_phone,created_at").eq("school_id",t.school_id).order("full_name",{ascending:!0})]);if(s.error||l.error)throw s.error||l.error;g(s.data??[]),u(l.data??[])}catch(t){let e=t instanceof Error?t.message:"تعذر تحميل النتائج.";i.Ay.error(e)}finally{t(!1)}},[]);(0,l.useEffect)(()=>{A()},[A]);let S=async e=>{if(r&&C&&window.confirm(`هل تريد حذف الاختبار: ${e.title}؟`))try{let{error:t}=await p.from("exams").delete().eq("id",e.id).eq("school_id",r);if(t)throw t;i.Ay.success("تم حذف الاختبار."),await A()}catch(t){let e=t instanceof Error?t.message:"تعذر حذف الاختبار.";i.Ay.error(e)}};return e?(0,s.jsx)("section",{dir:"rtl",className:"flex min-h-[65vh] items-center justify-center",children:(0,s.jsx)("div",{className:"h-11 w-11 animate-spin rounded-full border-4 border-primary-100 border-t-primary-600"})}):r?(0,s.jsxs)("section",{dir:"rtl",className:"space-y-5",children:[(0,s.jsx)("header",{className:"rounded-xl bg-white p-6 shadow-md",children:(0,s.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-primary-700",children:"الاختبارات والنتائج"}),(0,s.jsx)("p",{className:"mt-2 text-gray-600",children:"إنشاء اختبارات وإدخال درجات الطلبة."})]}),C?(0,s.jsxs)("button",{type:"button",onClick:()=>{N(null),f(!0)},className:"inline-flex min-h-[44px] items-center justify-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:[(0,s.jsx)(a.A,{className:"h-4 w-4"}),"اختبار جديد"]}):null]})}),0===y.length?(0,s.jsxs)("section",{className:"rounded-xl bg-white p-6 text-center shadow-md",children:[(0,s.jsx)("p",{className:"mb-4 text-gray-600",children:"لا توجد اختبارات مسجلة حاليًا."}),C?(0,s.jsx)("button",{type:"button",onClick:()=>{N(null),f(!0)},className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"إضافة أول اختبار"}):null]}):(0,s.jsx)("section",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2",children:y.map(e=>(0,s.jsxs)("article",{className:"rounded-xl bg-white p-6 shadow-md",children:[(0,s.jsxs)("div",{className:"mb-2 flex items-start justify-between gap-2",children:[(0,s.jsx)("h2",{className:"text-lg font-bold text-gray-900",children:e.title}),(0,s.jsx)("span",{className:"rounded-full bg-primary-100 px-3 py-1 text-xs font-semibold text-primary-700",children:e.level})]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["تاريخ الاختبار: ",(0,o.Yq)(e.exam_date)]}),(0,s.jsxs)("p",{className:"mt-1 text-sm text-gray-600",children:["الدرجة القصوى: ",e.max_score]}),C?(0,s.jsxs)("div",{className:"mt-4 flex flex-wrap justify-end gap-2",children:[(0,s.jsx)("button",{type:"button",onClick:()=>{N(e),f(!0)},className:"min-h-[44px] rounded-lg bg-yellow-500 px-3 py-2 text-sm text-white",children:"تعديل"}),(0,s.jsx)("button",{type:"button",onClick:()=>{k(e),v(!0)},className:"min-h-[44px] rounded-lg bg-primary-600 px-3 py-2 text-sm text-white hover:bg-primary-700",children:"إدخال الدرجات"}),(0,s.jsx)("button",{type:"button",onClick:()=>{S(e)},className:"min-h-[44px] rounded-lg bg-red-600 px-3 py-2 text-sm text-white",children:"حذف"})]}):(0,s.jsx)("p",{className:"mt-4 text-sm text-gray-500",children:"عرض فقط"})]},e.id))}),(0,s.jsx)(x,{isOpen:b,onClose:()=>f(!1),onSuccess:()=>{f(!1),A()},schoolId:r,exam:j}),_?(0,s.jsx)(h,{isOpen:w,onClose:()=>v(!1),onSuccess:()=>{v(!1),A()},schoolId:r,exam:_,students:m,canManage:C}):null]}):(0,s.jsxs)("section",{dir:"rtl",className:"rounded-xl bg-white p-6 text-center shadow-md",children:[(0,s.jsx)("h1",{className:"mb-3 text-2xl font-bold text-primary-700",children:"لا توجد مدرسة مرتبطة"}),(0,s.jsx)("p",{className:"mb-6 text-gray-600",children:"أكمل الإعداد لإدارة الاختبارات والنتائج."}),(0,s.jsx)("a",{href:"/onboarding",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"إكمال الإعداد"})]})}},2806:(e,t,r)=>{"use strict";r.d(t,{A:()=>d});var s=r(2115);let l=(...e)=>e.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim(),a=e=>{let t=e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,r)=>r?r.toUpperCase():t.toLowerCase());return t.charAt(0).toUpperCase()+t.slice(1)};var i={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let n=(0,s.forwardRef)(({color:e="currentColor",size:t=24,strokeWidth:r=2,absoluteStrokeWidth:a,className:n="",children:d,iconNode:o,...c},m)=>(0,s.createElement)("svg",{ref:m,...i,width:t,height:t,stroke:e,strokeWidth:a?24*Number(r)/Number(t):r,className:l("lucide",n),...!d&&!(e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0;return!1})(c)&&{"aria-hidden":"true"},...c},[...o.map(([e,t])=>(0,s.createElement)(e,t)),...Array.isArray(d)?d:[d]])),d=(e,t)=>{let r=(0,s.forwardRef)(({className:r,...i},d)=>(0,s.createElement)(n,{ref:d,iconNode:t,className:l(`lucide-${a(e).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`,`lucide-${e}`,r),...i}));return r.displayName=a(e),r}},3210:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});let s=(0,r(2806).A)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},7236:(e,t,r)=>{"use strict";r.d(t,{U:()=>l});var s=r(6622);function l(){return(0,s.createBrowserClient)("https://zuppzhysrgmioyozrltp.supabase.co","sb_publishable_GQkKFgomb7ThK_H_csmdoQ_CYQOschE")}}},e=>{e.O(0,[143,409,441,794,358],()=>e(e.s=515)),_N_E=e.O()}]);