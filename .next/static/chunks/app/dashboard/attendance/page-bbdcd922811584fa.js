(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[437],{5374:(e,t,r)=>{Promise.resolve().then(r.bind(r,8090))},7236:(e,t,r)=>{"use strict";r.d(t,{U:()=>a});var s=r(6622);function a(){return(0,s.createBrowserClient)("https://zuppzhysrgmioyozrltp.supabase.co","sb_publishable_GQkKFgomb7ThK_H_csmdoQ_CYQOschE")}},8090:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>x});var s=r(5155),a=r(8500),l=r.n(a),d=r(2115),i=r(8434),n=r(7236);let c={present:"حاضر",absent:"غائب",late:"متأخر",excused:"بعذر"},o=(0,n.U)();function x(){let[e,t]=(0,d.useState)(!0),[r,a]=(0,d.useState)(!1),[n,x]=(0,d.useState)(null),[h,m]=(0,d.useState)(null),[p,u]=(0,d.useState)([]),[b,y]=(0,d.useState)(()=>new Date().toISOString().slice(0,10)),[f,g]=(0,d.useState)({}),j="school_admin"===h||"teacher"===h,N=(0,d.useCallback)(async()=>{t(!0);try{let{data:{user:e}}=await o.auth.getUser();if(!e)throw Error("يرجى تسجيل الدخول أولًا.");let{data:t,error:r}=await o.from("profiles").select("school_id, role").eq("id",e.id).single();if(r)throw r;if(m(t?.role??null),!t?.school_id){x(null),u([]),g({});return}x(t.school_id);let[s,a]=await Promise.all([o.from("students").select("id,school_id,full_name,level,parent_phone,created_at").eq("school_id",t.school_id).order("full_name",{ascending:!0}),o.from("attendance").select("student_id,status").eq("school_id",t.school_id).eq("date",b)]);if(s.error||a.error)throw s.error||a.error;let l=s.data??[];u(l);let d={};(a.data??[]).forEach(e=>{d[e.student_id]=e.status}),l.forEach(e=>{d[e.id]||(d[e.id]="present")}),g(d)}catch(t){let e=t instanceof Error?t.message:"تعذر تحميل بيانات الحضور.";i.Ay.error(e)}finally{t(!1)}},[b]);(0,d.useEffect)(()=>{N()},[N]);let w=(0,d.useMemo)(()=>{let e={present:0,absent:0,late:0,excused:0};return Object.values(f).forEach(t=>{e[t]+=1}),e},[f]),_=async()=>{if(!n)return void i.Ay.error("تعذر معرفة المدرسة الحالية.");if(!j)return void i.Ay.error("ليس لديك صلاحية حفظ الحضور.");a(!0);try{let e=p.map(e=>({school_id:n,student_id:e.id,date:b,status:f[e.id]??"present"})),{error:t}=await o.from("attendance").upsert(e,{onConflict:"student_id,date"});if(t)throw t;i.Ay.success("تم حفظ الحضور بنجاح."),await N()}catch(t){let e=t instanceof Error?t.message:"تعذر حفظ الحضور.";i.Ay.error(e)}finally{a(!1)}};return e?(0,s.jsx)("section",{dir:"rtl",className:"flex min-h-[65vh] items-center justify-center",children:(0,s.jsx)("div",{className:"h-11 w-11 animate-spin rounded-full border-4 border-primary-100 border-t-primary-600"})}):n?0===p.length?(0,s.jsxs)("section",{dir:"rtl",className:"rounded-xl bg-white p-6 text-center shadow-md",children:[(0,s.jsx)("h1",{className:"mb-3 text-2xl font-bold text-primary-700",children:"لا توجد قائمة طلبة"}),(0,s.jsx)("p",{className:"mb-6 text-gray-600",children:"أضف طلبة أولًا لتفعيل سجل الحضور."}),(0,s.jsx)(l(),{href:"/dashboard/students",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"إضافة طلبة"})]}):(0,s.jsxs)("section",{dir:"rtl",className:"space-y-5",children:[(0,s.jsxs)("header",{className:"rounded-xl bg-white p-6 shadow-md",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-primary-700",children:"سجل الحضور اليومي"}),(0,s.jsx)("p",{className:"mt-2 text-gray-600",children:"حدد تاريخًا ثم اختر حالة كل طالب."})]}),(0,s.jsx)("section",{className:"rounded-xl bg-white p-6 shadow-md",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"attendance-date",className:"mb-2 block text-sm font-semibold text-gray-700",children:"التاريخ"}),(0,s.jsx)("input",{id:"attendance-date",type:"date",value:b,onChange:e=>y(e.target.value),className:"w-full rounded-lg border border-gray-200 px-3 py-3 text-[16px] outline-none ring-primary-200 focus:ring"})]}),(0,s.jsxs)("div",{className:"rounded-lg bg-primary-50 p-4 text-center",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"حاضر"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-primary-700",children:w.present})]}),(0,s.jsxs)("div",{className:"rounded-lg bg-red-50 p-4 text-center",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"غائب"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-red-600",children:w.absent})]}),(0,s.jsxs)("div",{className:"rounded-lg bg-amber-50 p-4 text-center",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"متأخر/بعذر"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-amber-600",children:w.late+w.excused})]})]})}),(0,s.jsx)("section",{className:"overflow-hidden rounded-xl bg-white shadow-md",children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full text-right",children:[(0,s.jsx)("thead",{className:"bg-primary-50 text-sm text-primary-700",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3",children:"الطالب"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"المستوى"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"الحالة"})]})}),(0,s.jsx)("tbody",{children:p.map(e=>{let t=f[e.id]??"present";return(0,s.jsxs)("tr",{className:"border-t border-gray-100",children:[(0,s.jsx)("td",{className:"px-4 py-3 font-semibold text-gray-900",children:e.full_name}),(0,s.jsx)("td",{className:"px-4 py-3 text-gray-700",children:e.level}),(0,s.jsx)("td",{className:"px-4 py-3",children:(0,s.jsx)("div",{className:"flex flex-wrap justify-end gap-2",children:["present","absent","late","excused"].map(r=>(0,s.jsx)("button",{type:"button",onClick:()=>{var t;return t=e.id,void g(e=>({...e,[t]:r}))},className:`min-h-[44px] rounded-lg px-3 py-2 text-sm font-semibold ${t===r?"bg-primary-600 text-white":"bg-primary-50 text-primary-700 hover:bg-primary-100"}`,children:c[r]},`${e.id}-${r}`))})})]},e.id)})})]})})}),(0,s.jsx)("div",{className:"flex justify-end",children:(0,s.jsx)("button",{type:"button",disabled:!j||r,onClick:()=>{_()},className:"min-h-[44px] rounded-lg bg-primary-600 px-6 py-2 text-white hover:bg-primary-700 disabled:cursor-not-allowed disabled:opacity-50",children:r?"جارٍ الحفظ...":j?"حفظ الحضور":"قراءة فقط"})})]}):(0,s.jsxs)("section",{dir:"rtl",className:"rounded-xl bg-white p-6 text-center shadow-md",children:[(0,s.jsx)("h1",{className:"mb-3 text-2xl font-bold text-primary-700",children:"لا توجد مدرسة مرتبطة"}),(0,s.jsx)("p",{className:"mb-6 text-gray-600",children:"أكمل الإعداد حتى تتمكن من تسجيل الحضور."}),(0,s.jsx)(l(),{href:"/onboarding",className:"inline-flex min-h-[44px] items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700",children:"إكمال الإعداد"})]})}}},e=>{e.O(0,[143,500,441,794,358],()=>e(e.s=5374)),_N_E=e.O()}]);